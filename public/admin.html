<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>body{background:#0f1724;color:#e2e8f0} .card-dark{background:#0b1220;color:#e2e8f0} .actions-dropdown{min-width:180px}</style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark">
  
  <div class="row mb-3">
    <div class="col-lg-3">
      <div class="card shadow-sm">
        <div class="card-header fw-semibold">Th√¥ng b√°o g·∫ßn ƒë√¢y</div>
        <ul id="recentNotifications" class="list-group list-group-flush small"></ul>
      </div>
    </div>
    <div class="col-lg-9">
      <div id="quickActionsCard" class="card bg-dark text-light shadow-sm">
        <div class="card-header fw-semibold">Admin: ƒê·∫∑t h·∫°n m·ª©c cho user</div>
        <div class="card-body d-flex flex-wrap gap-2 align-items-end">
          <div class="me-2">
            <label class="form-label small mb-1">User ID</label>
            <input id="qaUserId" class="form-control form-control-sm" placeholder="Nh·∫≠p User ID">
          </div>
          <div class="me-2">
            <label class="form-label small mb-1">H·∫°n m·ª©c m·ªõi</label>
            <input id="qaNewLimit" class="form-control form-control-sm" type="number" placeholder="VD 100">
          </div>
          <button id="btnSetLimit" class="btn btn-sm btn-primary">C·∫≠p Nh·∫≠t H·∫°n m·ª©c m·ªõi</button>
          <button id="btnResetSms" class="btn btn-sm btn-secondary">Reset B·ªô ƒê·∫øm SMS" onclick="resetSMS()"</button>
          <button id="btnMakeAdmin" class="btn btn-sm btn-warning">Chuy·ªÉn Th√†nh User Admin" onclick="makeAdmin()"</button>
          <button id="btnNotify" class="btn btn-sm btn-info">G·ª≠i th√¥ng b√°o ƒë·∫øn user</button>
          <button id="btnDetail" class="btn btn-sm btn-outline-light">Detail User</button>
          <button id="btnCheckFeedback" class="btn btn-sm btn-outline-light">Check Feedback user</button>
          <button id="btnBlockUser" class="btn btn-sm btn-danger">Block user" onclick="blockUser()"</button>
        </div>
        <div class="card-footer small">
          <span>ƒê√£ g·ª≠i: <span id="sentCount">0</span> / <span id="sentLimit">999999</span></span>
          <span class="ms-3">Reset at: <span id="resetTime">--</span></span>
        </div>
      </div>
    </div>
    <div class="col-lg-3">
      <div class="card bg-primary-subtle shadow-sm">
        <div class="card-header">Th√¥ng b√°o SMS t·ª´ ng∆∞·ªùi d√πng</div>
        <div class="card-body small" id="latestSmsBox">
          Ch∆∞a c√≥ th√¥ng b√°o m·ªõi.
        </div>
      </div>
    </div>
  </div>

<div class="container-fluid">
    <a class="navbar-brand" href="#">Admin Dashboard</a>
    <div class="d-flex">
      <a class="btn btn-light me-2" href="/trang-chu.html">üè† Trang ch·ªß</a>
      <span id="adminName" class="navbar-text text-light"></span>
    </div>
  </div>
</nav>
<main class="container my-4">
  <div class="row mb-3">
    <div class="col-lg-3">
      <div class="card shadow-sm">
        <div class="card-header fw-semibold">Th√¥ng b√°o g·∫ßn ƒë√¢y</div>
        <ul id="recentNotifications" class="list-group list-group-flush small"></ul>
      </div>
    </div>
    <div class="col"><div class="card card-dark p-3 text-center"><h5>T·ªïng s·ªë user</h5><div id="statTotalUsers">0</div></div></div>
    <div class="col"><div class="card card-dark p-3 text-center"><h5>T·ªïng tin nh·∫Øn h√¥m nay</h5><div id="statTotalMsgs">0</div></div></div>
    <div class="col"><div class="card card-dark p-3 text-center"><h5>User v∆∞·ª£t h·∫°n m·ª©c</h5><div id="statExceeded">0</div></div></div>
    <div class="col"><div class="card card-dark p-3 text-center"><h5>B·ªã ch·∫∑n</h5><div id="statBanned">0</div></div></div>
    <div class="col"><div class="card card-dark p-3 text-center"><h5>SMS b·ªã ch·∫∑n</h5><div id="statSmsBlocked">0</div></div></div>
  </div>

  <div class="card card-dark p-3 mb-3">
    <div class="d-flex mb-2">
      <input id="searchInput" class="form-control me-2" placeholder="T√¨m theo username / email / phone" />
      <button id="searchBtn" class="btn btn-outline-light">T√¨m</button>
      <button id="resetBtn" class="btn btn-secondary ms-2">T·∫£i l·∫°i</button>
    </div>
    <div class="table-responsive" style="max-height:520px; overflow:auto;">
      <table class="table table-dark table-striped" id="usersTable">
        <thead><tr><th></th>
          <th>Email</th><th>T√™n</th><th>Thu nh·∫≠p</th><th>C√¥ng vi·ªác</th><th>Phone</th><th>Role</th><th>SentToday</th>
          <th>Daily</th><th>Weekly</th><th>Monthly</th><th>Yearly</th><th>Password</th><th>Ng√†y t·∫°o</th><th>Actions</th>
        </tr>
<tr class="filters-row">
  <th><input class='form-control form-control-sm' data-col='email' placeholder='l·ªçc email'></th>
  <th><input class='form-control form-control-sm' data-col='username' placeholder='l·ªçc t√™n'></th>
  <th><input class='form-control form-control-sm' data-col='income' placeholder='l·ªçc thu nh·∫≠p'></th>
  <th><input class='form-control form-control-sm' data-col='job' placeholder='l·ªçc c√¥ng vi·ªác'></th>
  <th><input class='form-control form-control-sm' data-col='phone' placeholder='l·ªçc phone'></th>
  <th><select class='form-select form-select-sm' data-col='role'><option value=''>T·∫•t c·∫£</option><option>user</option><option>admin</option><option>superadmin</option></select></th>
  <th><input class='form-control form-control-sm' data-col='sentToday' placeholder='‚â• s·ªë'></th>
  <th><input class='form-control form-control-sm' data-col='dailyLimit' placeholder='‚â•'></th>
  <th><input class='form-control form-control-sm' data-col='weeklyLimit' placeholder='‚â•'></th>
  <th><input class='form-control form-control-sm' data-col='monthlyLimit' placeholder='‚â•'></th>
  <th><input class='form-control form-control-sm' data-col='yearlyLimit' placeholder='‚â•'></th>
  <th><input class='form-control form-control-sm' data-col='createdAt' placeholder='yyyy-mm-dd'></th>
  <th></th>
</tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</main>

<!-- Set Limit Modal -->
<div class="modal fade" id="setLimitModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content bg-dark text-light">
    <div class="modal-header"><h5 class="modal-title">ƒê·∫∑t h·∫°n m·ª©c</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <select id="limitType" class="form-select mb-2">
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
        <option value="yearly">Yearly</option>
      </select>
      <input id="newLimitInput" class="form-control" type="number" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng m·ªõi" />
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
      <button id="confirmSetLimitBtn" class="btn btn-primary">X√°c nh·∫≠n</button>
    </div>
  </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js">
/* Admin Filters & PW Toggle + Pagination/Toast/Bulk */
let _cachedUsers = [];
const ONE_DAY = 24*60*60*1000;
function markNewBadges(){
  document.querySelectorAll('#usersTable tbody tr').forEach(tr=>{
    const dateCell = tr.querySelector('td:nth-last-child(1)'); // createdAt column
    const timeText = dateCell?.textContent?.trim();
    const badge = tr.querySelector('.new-badge');
    try{
      const created = new Date(timeText);
      if (Date.now()-created.getTime() < ONE_DAY) { if (badge) badge.style.display='inline-block'; }
      else { if (badge) badge.style.display='none'; }
    }catch(e){}
  });
}
function bindPwButtons(){
  document.querySelectorAll('#usersTable tbody tr').forEach(tr=>{
    const span = tr.querySelector('.pw');
    const toggle = tr.querySelector('.togglePw');
    const copy = tr.querySelector('.copyPw');
    if (toggle){
      toggle.onclick = ()=>{
        if (span.textContent==='‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'){ span.textContent = span.dataset.pw||''; toggle.textContent='·∫®n'; }
        else { span.textContent='‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'; toggle.textContent='Hi·ªán'; }
      };
    }
    if (copy){
      copy.onclick = async ()=>{ try{ await navigator.clipboard.writeText(span.dataset.pw||''); copy.textContent='ƒê√£ copy'; setTimeout(()=>copy.textContent='Copy',1000);}catch(e){} };
    }
  });
}
function applyColumnFilters(){
  const inputs = Array.from(document.querySelectorAll('.filters-row [data-col]'));
  const obj = {}; inputs.forEach(i=>obj[i.dataset.col]=i.value.trim());
  const numCols = new Set(['sentToday','dailyLimit','weeklyLimit','monthlyLimit','yearlyLimit']);
  const tbody = document.querySelector('#usersTable tbody');
  const filtered = _cachedUsers.filter(u=>{
    return Object.entries(obj).every(([k,v])=>{
      if (!v) return true;
      if (k==='createdAt'){ try { return (new Date(u.createdAt).toISOString().slice(0,10)).includes(v); } catch(_){ return true; } }
      if (numCols.has(k)) return (u[k]||0) >= Number(v||0);
      const val = (u[k]||'')+''; return val.toLowerCase().includes(v.toLowerCase());
    });
  });
  renderRows(filtered);
}
function bindFilterInputs(){
  document.querySelectorAll('.filters-row [data-col]').forEach(i=>{ i.oninput = applyColumnFilters; });
}
function renderRows(users){
  const tbody=document.querySelector('#usersTable tbody');
  tbody.innerHTML='';
  users.forEach(u=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td><input type='checkbox' class='rowCheck' data-id='${u._id}'/></td><td>${u.email||'Ch∆∞a c·∫≠p nh·∫≠t'} <button class='btn btn-sm btn-outline-secondary ms-1' onclick="navigator.clipboard.writeText('${u.email||''}')">Copy</button></td><td>${u.username||'Ch∆∞a c·∫≠p nh·∫≠t'}</td>
      <td>${u.income||'Ch∆∞a c·∫≠p nh·∫≠t'}</td><td>${u.job||'Ch∆∞a c·∫≠p nh·∫≠t'}</td><td>${u.phone||'Ch∆∞a c·∫≠p nh·∫≠t'} <button class='btn btn-sm btn-outline-secondary ms-1' onclick="navigator.clipboard.writeText('${u.phone||''}')">Copy</button></td>
      <td>${u.role||'user'}</td><td>${u.sentToday||0}</td>
      <td>${u.dailyLimit||0}</td><td>${u.weeklyLimit||0}</td><td>${u.monthlyLimit||0}</td><td>${u.yearlyLimit||0}</td>
      <td><span class='pw' data-pw='${u.plainPassword||''}'>‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span> <button class='btn btn-sm btn-outline-secondary ms-1 togglePw'>Hi·ªán</button> <button class='btn btn-sm btn-outline-secondary ms-1 copyPw'>Copy</button></td>
      <td>${u.createdAt ? (new Date(u.createdAt).toLocaleString()) : ''} <span class='badge bg-success new-badge' style='display:none;'>NEW</span></td>
      <td>
        <div class="dropdown">
          <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Actions</button>
          <ul class="dropdown-menu dropdown-menu-dark actions-dropdown">
            <li><a class="dropdown-item" href="#" onclick="openSetLimit('${u._id}')">Set Limit</a></li>
            <li><a class="dropdown-item" href="#" onclick="resetQuota('${u._id}')">Reset</a></li>
            <li><a class="dropdown-item" href="#" onclick="viewAccount('${u._id}')">Truy c·∫≠p</a></li>
            ${u.isBanned ? `<li><a class="dropdown-item text-success" href="#" onclick="banAccount('${u._id}')">B·ªè ch·∫∑n</a></li>` : `<li><a class="dropdown-item text-danger" href="#" onclick="banAccount('${u._id}')">Ch·∫∑n t√†i kho·∫£n</a></li>`}
            ${u.smsBlocked ? `<li><a class="dropdown-item text-success" href="#" onclick="blockSms('${u._id}')">B·ªè ch·∫∑n SMS</a></li>` : `<li><a class="dropdown-item text-warning" href="#" onclick="blockSms('${u._id}')">Ch·∫∑n SMS</a></li>`}
          </ul>
        </div>
      </td>`;
    tbody.appendChild(tr);
  });
  bindPwButtons();
  markNewBadges();
}

function showToast(msg, type='success'){
  const wrap=document.getElementById('toastContainer');
  const id='t'+Date.now();
  const div=document.createElement('div');
  div.id=id;
  div.className='alert ' + (type==='error'?'alert-danger':'alert-success');
  div.style.minWidth='240px'; div.style.marginTop='8px'; div.innerText=msg;
  wrap.appendChild(div);
  setTimeout(()=>{ div.remove(); }, 2500);
}

let _cachedUsers = [];
const ONE_DAY = 24*60*60*1000;
let _page=1, _pageSize=50, _total=0;

function renderPagination(){
  const bar=document.getElementById('paginationBar');
  const pages=Math.max(1, Math.ceil(_total/_pageSize));
  bar.innerHTML = `Trang ${_page}/${pages}
    <button class='btn btn-sm btn-outline-light ms-2' ${_page<=1?'disabled':''} id='pgPrev'>Prev</button>
    <button class='btn btn-sm btn-outline-light ms-1' ${_page>=pages?'disabled':''} id='pgNext'>Next</button>`;
  const prev=document.getElementById('pgPrev'); const next=document.getElementById('pgNext');
  if(prev) prev.onclick=()=>{ if(_page>1){ _page--; loadUsers(); } };
  if(next) next.onclick=()=>{ const pages=Math.ceil(_total/_pageSize); if(_page<pages){ _page++; loadUsers(); } };
}

function getCheckedIds(){
  return Array.from(document.querySelectorAll('.rowCheck:checked')).map(ch=>ch.dataset.id);
}

async function bulk(action, value){
  const ids=getCheckedIds();
  if(ids.length===0) return showToast('Ch∆∞a ch·ªçn user','error');
  try{
    const res=await fetch('/api/admin/bulk-actions',{ method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}, body: JSON.stringify({ ids, action, value })});
    if(!res.ok) throw new Error(await res.text());
    showToast('Th√†nh c√¥ng');
    loadUsers();
  }catch(e){ showToast('L·ªói: '+e.message, 'error'); }
}

document.addEventListener('DOMContentLoaded', ()=>{
  const b=document.getElementById('bulkBan'); if(b) b.onclick=()=>bulk('ban');
  const s=document.getElementById('bulkSms'); if(s) s.onclick=()=>bulk('smsBlock');
  const p10=document.getElementById('pkg10'); if(p10) p10.onclick=()=>bulk('setLimit',10);
  const p50=document.getElementById('pkg50'); if(p50) p50.onclick=()=>bulk('setLimit',50);
  const p100=document.getElementById('pkg100'); if(p100) p100.onclick=()=>bulk('setLimit',100);
});

const _origLoadUsers = loadUsers;

loadUsers = async function(q){
  const res = await fetch('/api/admin/users'+(q?('?q='+encodeURIComponent(q)):'')+'&page=${_page}&pageSize=${_pageSize}',{headers:{'Authorization':'Bearer '+token}});
  if(!res.ok){console.error(res.status); return;}
  const data = await res.json();
  _cachedUsers = data.users; _total=data.total; _page=data.page; _pageSize=data.pageSize;
  renderRows(_cachedUsers);
  renderPagination();
  bindFilterInputs();
}

function toast(msg){ try{ const el = document.getElementById('toast'); if(el){ el.innerText=msg; } }catch(e){} }

async function qaCall(url, options){
  const res = await fetch(url, { ...(options||{}), headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer '+token }});
  if(!res.ok){ const t=await res.text(); throw new Error(t||res.status); }
  return res.json().catch(()=>({success:true}));
}

function bindQuickActions(){
  const $id = (id)=>document.getElementById(id);
  $id('btnSetLimit').onclick = async ()=>{
    const userId = $id('qaUserId').value.trim();
    const limit = parseInt($id('qaNewLimit').value||'0',10);
    if(!userId) return alert('Nh·∫≠p User ID');
    await qaCall('/api/admin/set-limit', { method:'POST', body: JSON.stringify({ userId, limit })});
    loadUsers();
  };
  $id('btnResetSms').onclick = async ()=>{
    const userId = $id('qaUserId').value.trim();
    if(!userId) return alert('Nh·∫≠p User ID');
    await qaCall('/api/admin/reset-daily/'+encodeURIComponent(userId), { method:'POST' });
    loadUsers();
  };
  $id('btnMakeAdmin').onclick = async ()=>{
    const userId = $id('qaUserId').value.trim();
    if(!userId) return alert('Nh·∫≠p User ID');
    await qaCall('/api/admin/make-admin', { method:'POST', body: JSON.stringify({ userId })});
    loadUsers();
  };
  $id('btnNotify').onclick = async ()=>{
    const userId = $id('qaUserId').value.trim();
    const message = prompt('Nh·∫≠p n·ªôi dung th√¥ng b√°o:');
    if(message===null) return;
    await qaCall('/api/admin/notify', { method:'POST', body: JSON.stringify({ userId, message, title: 'Th√¥ng b√°o t·ª´ Admin' })});
    alert('ƒê√£ g·ª≠i th√¥ng b√°o');
  };
  $id('btnDetail').onclick = ()=>{
    const userId = document.getElementById('qaUserId').value.trim();
    if(!userId) return alert('Nh·∫≠p User ID');
    window.location.href = '/profile.html?uid='+encodeURIComponent(userId);
  };
  $id('btnCheckFeedback').onclick = ()=>{
    const userId = document.getElementById('qaUserId').value.trim();
    if(!userId) return alert('Nh·∫≠p User ID');
    window.open('/feedback.html?uid='+encodeURIComponent(userId), '_blank');
  };
  $id('btnBlockUser').onclick = async ()=>{
    const userId = document.getElementById('qaUserId').value.trim();
    if(!userId) return alert('Nh·∫≠p User ID');
    await qaCall('/api/admin/ban/'+encodeURIComponent(userId), { method:'POST' });
    loadUsers();
  };
}

async function loadLatestSms(){
  try{
    const res = await fetch('/api/admin/latest-sms-request', { headers: { 'Authorization': 'Bearer '+token }});
    if(res.ok){
      const n = await res.json();
      const box = document.getElementById('latestSmsBox');
      if (n){
        box.innerHTML = `<div><b>${n.title||'Y√™u c·∫ßu SMS'}</b></div>
        <div>${n.message||''}</div>
        <div class='text-muted mt-1'>${new Date(n.createdAt).toLocaleString()}</div>`;
      } else { box.innerText='Ch∆∞a c√≥ th√¥ng b√°o m·ªõi.'; }
    }
  }catch(e){}
}

document.addEventListener('DOMContentLoaded', ()=>{
  bindQuickActions();
  loadLatestSms();
});

async function loadNotifications(){
  try{
    const res = await fetch('/api/admin/notifications?limit=5',{ headers:{ 'Authorization':'Bearer '+token }});
    if(res.ok){
      const notes = await res.json();
      const ul = document.getElementById('recentNotifications');
      if(ul){
        ul.innerHTML = '';
        notes.forEach(n=>{
          const li=document.createElement('li');
          li.className='list-group-item';
          li.innerHTML=`<b>${n.type}</b>: ${n.message} <div class='text-muted'>${new Date(n.createdAt).toLocaleString()}</div>`;
          ul.appendChild(li);
        });
      }
    }
  }catch(e){}
}

document.addEventListener('DOMContentLoaded', ()=>{
  loadNotifications();
  try{
    const evtSource=new EventSource('/api/admin/stream-events?token='+token);
    evtSource.onmessage=(e)=>{
      const data=JSON.parse(e.data);
      if(data.type==='new-user'){
        showToast(`üîî C√≥ user m·ªõi: ${data.message}`);
        loadUsers();
        loadNotifications();
      }
    };
  }catch(e){ console.error('SSE failed', e); }
});
</script>



<script>
let token = localStorage.getItem('token'); if(!token) location.href='/login.html';
let currentUserId=null;

async function checkProfile(){
  const res=await fetch('/api/profile',{headers:{'Authorization':'Bearer '+token}});
  if(!res.ok){location.href='/';return;}
  const data=await res.json();
  document.getElementById('adminName').innerText = data.username + ' ('+(data.role||'')+')';
  if(!['admin','superadmin'].includes(data.role)) { location.href='/'; return;}
  loadUsers();
}

async function loadUsers(q){
  const url = '/api/admin/users' + (q?('?q='+encodeURIComponent(q)): '');
  const res=await fetch(url,{headers:{'Authorization':'Bearer '+token}});
  if(!res.ok){console.error(res.status); return;}
  const users=await res.json();
  const tbody=document.querySelector('#usersTable tbody');
  tbody.innerHTML='';
  let totalMsgs=0, exceeded=0, banned=0, smsblocked=0;
  users.forEach(u=>{
    totalMsgs += u.sentToday||0;
    if((u.sentToday||0) > (u.dailyLimit||0)) exceeded++;
    if(u.isBanned) banned++;
    if(u.smsBlocked) smsblocked++;
    const tr=document.createElement('tr');
    tr.innerHTML = `<td><input type='checkbox' class='rowCheck' data-id='${u._id}'/></td><td>${u.email||'Ch∆∞a c·∫≠p nh·∫≠t'} <button class='btn btn-sm btn-outline-secondary ms-1' onclick="navigator.clipboard.writeText('${'${u.email||''}'}')">Copy</button></td><td>${u.username||'Ch∆∞a c·∫≠p nh·∫≠t'}</td>
      <td>${u.income||'Ch∆∞a c·∫≠p nh·∫≠t'}</td><td>${u.job||'Ch∆∞a c·∫≠p nh·∫≠t'}</td><td>${u.phone||'Ch∆∞a c·∫≠p nh·∫≠t'}</td>
      <td>${u.role||'user'}</td><td>${u.sentToday||0}</td>
      <td>${u.dailyLimit||0}</td><td>${u.weeklyLimit||0}</td><td>${u.monthlyLimit||0}</td><td>${u.yearlyLimit||0}</td>
      <td><span class='pw' data-pw='${u.plainPassword||''}'>‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span> <button class='btn btn-sm btn-outline-secondary ms-1 togglePw'>Hi·ªán</button> <button class='btn btn-sm btn-outline-secondary ms-1 copyPw'>Copy</button></td>
      <td>${u.createdAt ? (new Date(u.createdAt).toLocaleString()) : ''} <span class='badge bg-success new-badge' style='display:none;'>NEW</span></td>
      <td>
        <div class="btn-group">
          <button class="btn btn-sm btn-outline-light" data-bs-toggle="dropdown">Actions</button>
          <ul class="dropdown-menu actions-dropdown">
            <li><a class="dropdown-item" href="#" onclick="openSetLimit('${u._id}');return false;">Set Limit</a></li>
            <li><a class="dropdown-item" href="#" onclick="resetQuota('${u._id}');return false;">Reset Sent</a></li>
            <li><a class="dropdown-item" href="#" onclick="viewAccount('${u._id}');return false;">Truy c·∫≠p</a></li>
            <li><a class="dropdown-item" href="#" onclick="banAccount('${u._id}');return false;">Ch·∫∑n t√†i kho·∫£n</a></li>
            <li><a class="dropdown-item" href="#" onclick="blockSms('${u._id}');return false;">Ch·∫∑n SMS</a></li>
          </ul>
        </div>
      </td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('statTotalUsers').innerText = users.length;
  document.getElementById('statTotalMsgs').innerText = totalMsgs;
  document.getElementById('statExceeded').innerText = exceeded;
  document.getElementById('statBanned').innerText = banned;
  document.getElementById('statSmsBlocked').innerText = smsblocked;
}

function openSetLimit(id){ currentUserId=id; new bootstrap.Modal(document.getElementById('setLimitModal')).show(); }
document.getElementById('confirmSetLimitBtn').addEventListener('click', async ()=>{
  const type = document.getElementById('limitType').value;
  const v = Number(document.getElementById('newLimitInput').value)||0;
  await fetch('/api/admin/set-limit',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}, body: JSON.stringify({ userId: currentUserId, type, value: v })});
  bootstrap.Modal.getInstance(document.getElementById('setLimitModal')).hide();
  loadUsers();
});
async function resetQuota(id){ await fetch('/api/admin/reset-daily/'+id,{method:'POST',headers:{'Authorization':'Bearer '+token}}); loadUsers(); }
async function banAccount(id){ await fetch('/api/admin/ban/'+id,{method:'POST',headers:{'Authorization':'Bearer '+token}}); loadUsers(); }
async function blockSms(id){ await fetch('/api/admin/block-sms/'+id,{method:'POST',headers:{'Authorization':'Bearer '+token}}); loadUsers(); }
function viewAccount(id){ window.location.href='/profile.html?uid='+id; }
document.getElementById('searchBtn').addEventListener('click', ()=>{ const q = document.getElementById('searchInput').value.trim(); loadUsers(q); });
document.getElementById('resetBtn').addEventListener('click', ()=>{ document.getElementById('searchInput').value=''; loadUsers(); });
checkProfile();

/* Admin Filters & PW Toggle + Pagination/Toast/Bulk */
let _cachedUsers = [];
const ONE_DAY = 24*60*60*1000;
function markNewBadges(){
  document.querySelectorAll('#usersTable tbody tr').forEach(tr=>{
    const dateCell = tr.querySelector('td:nth-last-child(1)'); // createdAt column
    const timeText = dateCell?.textContent?.trim();
    const badge = tr.querySelector('.new-badge');
    try{
      const created = new Date(timeText);
      if (Date.now()-created.getTime() < ONE_DAY) { if (badge) badge.style.display='inline-block'; }
      else { if (badge) badge.style.display='none'; }
    }catch(e){}
  });
}
function bindPwButtons(){
  document.querySelectorAll('#usersTable tbody tr').forEach(tr=>{
    const span = tr.querySelector('.pw');
    const toggle = tr.querySelector('.togglePw');
    const copy = tr.querySelector('.copyPw');
    if (toggle){
      toggle.onclick = ()=>{
        if (span.textContent==='‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'){ span.textContent = span.dataset.pw||''; toggle.textContent='·∫®n'; }
        else { span.textContent='‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'; toggle.textContent='Hi·ªán'; }
      };
    }
    if (copy){
      copy.onclick = async ()=>{ try{ await navigator.clipboard.writeText(span.dataset.pw||''); copy.textContent='ƒê√£ copy'; setTimeout(()=>copy.textContent='Copy',1000);}catch(e){} };
    }
  });
}
function applyColumnFilters(){
  const inputs = Array.from(document.querySelectorAll('.filters-row [data-col]'));
  const obj = {}; inputs.forEach(i=>obj[i.dataset.col]=i.value.trim());
  const numCols = new Set(['sentToday','dailyLimit','weeklyLimit','monthlyLimit','yearlyLimit']);
  const tbody = document.querySelector('#usersTable tbody');
  const filtered = _cachedUsers.filter(u=>{
    return Object.entries(obj).every(([k,v])=>{
      if (!v) return true;
      if (k==='createdAt'){ try { return (new Date(u.createdAt).toISOString().slice(0,10)).includes(v); } catch(_){ return true; } }
      if (numCols.has(k)) return (u[k]||0) >= Number(v||0);
      const val = (u[k]||'')+''; return val.toLowerCase().includes(v.toLowerCase());
    });
  });
  renderRows(filtered);
}
function bindFilterInputs(){
  document.querySelectorAll('.filters-row [data-col]').forEach(i=>{ i.oninput = applyColumnFilters; });
}
function renderRows(users){
  const tbody=document.querySelector('#usersTable tbody');
  tbody.innerHTML='';
  users.forEach(u=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td><input type='checkbox' class='rowCheck' data-id='${u._id}'/></td><td>${u.email||'Ch∆∞a c·∫≠p nh·∫≠t'} <button class='btn btn-sm btn-outline-secondary ms-1' onclick="navigator.clipboard.writeText('${u.email||''}')">Copy</button></td><td>${u.username||'Ch∆∞a c·∫≠p nh·∫≠t'}</td>
      <td>${u.income||'Ch∆∞a c·∫≠p nh·∫≠t'}</td><td>${u.job||'Ch∆∞a c·∫≠p nh·∫≠t'}</td><td>${u.phone||'Ch∆∞a c·∫≠p nh·∫≠t'} <button class='btn btn-sm btn-outline-secondary ms-1' onclick="navigator.clipboard.writeText('${u.phone||''}')">Copy</button></td>
      <td>${u.role||'user'}</td><td>${u.sentToday||0}</td>
      <td>${u.dailyLimit||0}</td><td>${u.weeklyLimit||0}</td><td>${u.monthlyLimit||0}</td><td>${u.yearlyLimit||0}</td>
      <td><span class='pw' data-pw='${u.plainPassword||''}'>‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span> <button class='btn btn-sm btn-outline-secondary ms-1 togglePw'>Hi·ªán</button> <button class='btn btn-sm btn-outline-secondary ms-1 copyPw'>Copy</button></td>
      <td>${u.createdAt ? (new Date(u.createdAt).toLocaleString()) : ''} <span class='badge bg-success new-badge' style='display:none;'>NEW</span></td>
      <td>
        <div class="dropdown">
          <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Actions</button>
          <ul class="dropdown-menu dropdown-menu-dark actions-dropdown">
            <li><a class="dropdown-item" href="#" onclick="openSetLimit('${u._id}')">Set Limit</a></li>
            <li><a class="dropdown-item" href="#" onclick="resetQuota('${u._id}')">Reset</a></li>
            <li><a class="dropdown-item" href="#" onclick="viewAccount('${u._id}')">Truy c·∫≠p</a></li>
            ${u.isBanned ? `<li><a class="dropdown-item text-success" href="#" onclick="banAccount('${u._id}')">B·ªè ch·∫∑n</a></li>` : `<li><a class="dropdown-item text-danger" href="#" onclick="banAccount('${u._id}')">Ch·∫∑n t√†i kho·∫£n</a></li>`}
            ${u.smsBlocked ? `<li><a class="dropdown-item text-success" href="#" onclick="blockSms('${u._id}')">B·ªè ch·∫∑n SMS</a></li>` : `<li><a class="dropdown-item text-warning" href="#" onclick="blockSms('${u._id}')">Ch·∫∑n SMS</a></li>`}
          </ul>
        </div>
      </td>`;
    tbody.appendChild(tr);
  });
  bindPwButtons();
  markNewBadges();
}

function showToast(msg, type='success'){
  const wrap=document.getElementById('toastContainer');
  const id='t'+Date.now();
  const div=document.createElement('div');
  div.id=id;
  div.className='alert ' + (type==='error'?'alert-danger':'alert-success');
  div.style.minWidth='240px'; div.style.marginTop='8px'; div.innerText=msg;
  wrap.appendChild(div);
  setTimeout(()=>{ div.remove(); }, 2500);
}

let _cachedUsers = [];
const ONE_DAY = 24*60*60*1000;
let _page=1, _pageSize=50, _total=0;

function renderPagination(){
  const bar=document.getElementById('paginationBar');
  const pages=Math.max(1, Math.ceil(_total/_pageSize));
  bar.innerHTML = `Trang ${_page}/${pages}
    <button class='btn btn-sm btn-outline-light ms-2' ${_page<=1?'disabled':''} id='pgPrev'>Prev</button>
    <button class='btn btn-sm btn-outline-light ms-1' ${_page>=pages?'disabled':''} id='pgNext'>Next</button>`;
  const prev=document.getElementById('pgPrev'); const next=document.getElementById('pgNext');
  if(prev) prev.onclick=()=>{ if(_page>1){ _page--; loadUsers(); } };
  if(next) next.onclick=()=>{ const pages=Math.ceil(_total/_pageSize); if(_page<pages){ _page++; loadUsers(); } };
}

function getCheckedIds(){
  return Array.from(document.querySelectorAll('.rowCheck:checked')).map(ch=>ch.dataset.id);
}

async function bulk(action, value){
  const ids=getCheckedIds();
  if(ids.length===0) return showToast('Ch∆∞a ch·ªçn user','error');
  try{
    const res=await fetch('/api/admin/bulk-actions',{ method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}, body: JSON.stringify({ ids, action, value })});
    if(!res.ok) throw new Error(await res.text());
    showToast('Th√†nh c√¥ng');
    loadUsers();
  }catch(e){ showToast('L·ªói: '+e.message, 'error'); }
}

document.addEventListener('DOMContentLoaded', ()=>{
  const b=document.getElementById('bulkBan'); if(b) b.onclick=()=>bulk('ban');
  const s=document.getElementById('bulkSms'); if(s) s.onclick=()=>bulk('smsBlock');
  const p10=document.getElementById('pkg10'); if(p10) p10.onclick=()=>bulk('setLimit',10);
  const p50=document.getElementById('pkg50'); if(p50) p50.onclick=()=>bulk('setLimit',50);
  const p100=document.getElementById('pkg100'); if(p100) p100.onclick=()=>bulk('setLimit',100);
});

const _origLoadUsers = loadUsers;

loadUsers = async function(q){
  const res = await fetch('/api/admin/users'+(q?('?q='+encodeURIComponent(q)):'')+'&page=${_page}&pageSize=${_pageSize}',{headers:{'Authorization':'Bearer '+token}});
  if(!res.ok){console.error(res.status); return;}
  const data = await res.json();
  _cachedUsers = data.users; _total=data.total; _page=data.page; _pageSize=data.pageSize;
  renderRows(_cachedUsers);
  renderPagination();
  bindFilterInputs();
}

function toast(msg){ try{ const el = document.getElementById('toast'); if(el){ el.innerText=msg; } }catch(e){} }

async function qaCall(url, options){
  const res = await fetch(url, { ...(options||{}), headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer '+token }});
  if(!res.ok){ const t=await res.text(); throw new Error(t||res.status); }
  return res.json().catch(()=>({success:true}));
}

function bindQuickActions(){
  const $id = (id)=>document.getElementById(id);
  $id('btnSetLimit').onclick = async ()=>{
    const userId = $id('qaUserId').value.trim();
    const limit = parseInt($id('qaNewLimit').value||'0',10);
    if(!userId) return alert('Nh·∫≠p User ID');
    await qaCall('/api/admin/set-limit', { method:'POST', body: JSON.stringify({ userId, limit })});
    loadUsers();
  };
  $id('btnResetSms').onclick = async ()=>{
    const userId = $id('qaUserId').value.trim();
    if(!userId) return alert('Nh·∫≠p User ID');
    await qaCall('/api/admin/reset-daily/'+encodeURIComponent(userId), { method:'POST' });
    loadUsers();
  };
  $id('btnMakeAdmin').onclick = async ()=>{
    const userId = $id('qaUserId').value.trim();
    if(!userId) return alert('Nh·∫≠p User ID');
    await qaCall('/api/admin/make-admin', { method:'POST', body: JSON.stringify({ userId })});
    loadUsers();
  };
  $id('btnNotify').onclick = async ()=>{
    const userId = $id('qaUserId').value.trim();
    const message = prompt('Nh·∫≠p n·ªôi dung th√¥ng b√°o:');
    if(message===null) return;
    await qaCall('/api/admin/notify', { method:'POST', body: JSON.stringify({ userId, message, title: 'Th√¥ng b√°o t·ª´ Admin' })});
    alert('ƒê√£ g·ª≠i th√¥ng b√°o');
  };
  $id('btnDetail').onclick = ()=>{
    const userId = document.getElementById('qaUserId').value.trim();
    if(!userId) return alert('Nh·∫≠p User ID');
    window.location.href = '/profile.html?uid='+encodeURIComponent(userId);
  };
  $id('btnCheckFeedback').onclick = ()=>{
    const userId = document.getElementById('qaUserId').value.trim();
    if(!userId) return alert('Nh·∫≠p User ID');
    window.open('/feedback.html?uid='+encodeURIComponent(userId), '_blank');
  };
  $id('btnBlockUser').onclick = async ()=>{
    const userId = document.getElementById('qaUserId').value.trim();
    if(!userId) return alert('Nh·∫≠p User ID');
    await qaCall('/api/admin/ban/'+encodeURIComponent(userId), { method:'POST' });
    loadUsers();
  };
}

async function loadLatestSms(){
  try{
    const res = await fetch('/api/admin/latest-sms-request', { headers: { 'Authorization': 'Bearer '+token }});
    if(res.ok){
      const n = await res.json();
      const box = document.getElementById('latestSmsBox');
      if (n){
        box.innerHTML = `<div><b>${n.title||'Y√™u c·∫ßu SMS'}</b></div>
        <div>${n.message||''}</div>
        <div class='text-muted mt-1'>${new Date(n.createdAt).toLocaleString()}</div>`;
      } else { box.innerText='Ch∆∞a c√≥ th√¥ng b√°o m·ªõi.'; }
    }
  }catch(e){}
}

document.addEventListener('DOMContentLoaded', ()=>{
  bindQuickActions();
  loadLatestSms();
});

async function loadNotifications(){
  try{
    const res = await fetch('/api/admin/notifications?limit=5',{ headers:{ 'Authorization':'Bearer '+token }});
    if(res.ok){
      const notes = await res.json();
      const ul = document.getElementById('recentNotifications');
      if(ul){
        ul.innerHTML = '';
        notes.forEach(n=>{
          const li=document.createElement('li');
          li.className='list-group-item';
          li.innerHTML=`<b>${n.type}</b>: ${n.message} <div class='text-muted'>${new Date(n.createdAt).toLocaleString()}</div>`;
          ul.appendChild(li);
        });
      }
    }
  }catch(e){}
}

document.addEventListener('DOMContentLoaded', ()=>{
  loadNotifications();
  try{
    const evtSource=new EventSource('/api/admin/stream-events?token='+token);
    evtSource.onmessage=(e)=>{
      const data=JSON.parse(e.data);
      if(data.type==='new-user'){
        showToast(`üîî C√≥ user m·ªõi: ${data.message}`);
        loadUsers();
        loadNotifications();
      }
    };
  }catch(e){ console.error('SSE failed', e); }
});
</script>




<div id="toastContainer" style="position:fixed; top:16px; right:16px; z-index:2000;"></div>

<script>
const API = '/api';

async function updateLimit(){
  const userId = document.getElementById('limitUserId').value.trim();
  const value = document.getElementById('limitValue').value.trim();
  if(!userId || !value) return alert('Nh·∫≠p User ID v√† h·∫°n m·ª©c');
  const type = 'daily'; // default daily limit, can be extended
  const r = await fetch(API+'/admin/set-limit',{
    method:'POST',
    headers:{'Content-Type':'application/json', Authorization:'Bearer '+localStorage.getItem('token')},
    body: JSON.stringify({ userId, type, value })
  });
  if(r.ok) alert('C·∫≠p nh·∫≠t th√†nh c√¥ng'); else alert('L·ªói');
}

async function resetSMS(){
  const userId = document.getElementById('limitUserId').value.trim();
  if(!userId) return alert('Nh·∫≠p User ID');
  const r = await fetch(API+'/admin/reset-sms',{
    method:'POST',
    headers:{'Content-Type':'application/json', Authorization:'Bearer '+localStorage.getItem('token')},
    body: JSON.stringify({ userId })
  });
  if(r.ok) alert('ƒê√£ reset'); else alert('L·ªói');
}

async function blockUser(){
  const userId = document.getElementById('limitUserId').value.trim();
  if(!userId) return alert('Nh·∫≠p User ID');
  const r = await fetch(API+'/admin/bulk-actions',{
    method:'POST',
    headers:{'Content-Type':'application/json', Authorization:'Bearer '+localStorage.getItem('token')},
    body: JSON.stringify({ ids:[userId], action:'ban' })
  });
  if(r.ok) alert('User b·ªã block'); else alert('L·ªói');
}

async function makeAdmin(){
  const userId = document.getElementById('limitUserId').value.trim();
  if(!userId) return alert('Nh·∫≠p User ID');
  const r = await fetch(API+'/admin/bulk-actions',{
    method:'POST',
    headers:{'Content-Type':'application/json', Authorization:'Bearer '+localStorage.getItem('token')},
    body: JSON.stringify({ ids:[userId], action:'makeAdmin' })
  });
  if(r.ok) alert('User ƒë√£ th√†nh Admin'); else alert('L·ªói');
}
</script>

</body></html>
